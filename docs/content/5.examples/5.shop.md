---
title: Shop System
description: Purchase and transaction handling
navigation:
  icon: i-lucide-shopping-cart
---
## Setup
```lua
local shopDB = db:Collection("shop_items")
local transactionsDB = db:Collection("transactions")
shopDB:CreateIndex({ id = 1 }, true, "item_id_unique")
```
## Initialize Shop
```lua
function InitShop()
    local count = shopDB:Count({})
    if count > 0 then return end
    shopDB:InsertMany({
        {
            id = "health_kit",
            name = "Health Kit",
            price = 100,
            category = "medical"
        },
        {
            id = "armor_vest",
            name = "Armor Vest",
            price = 250,
            category = "armor"
        }
    })
end
```
## Purchase Item
```lua
function PurchaseItem(ply, itemId)
    local steamid = ply:SteamID()
    -- Get item
    local item = shopDB:FindOne({ id = itemId })
    if not item then
        return false, "Item not found"
    end
    -- Check and deduct credits
    local updated = playersDB:UpdateOne(
        {
            steamid = steamid,
            credits = { ["$gte"] = item.price }
        },
        {
            ["$inc"] = { credits = -item.price }
        }
    )
    if updated == 0 then
        return false, "Not enough credits"
    end
    -- Log transaction
    transactionsDB:InsertOne({
        steamid = steamid,
        username = ply:Nick(),
        item_id = itemId,
        price = item.price,
        created_at = os.time()
    })
    -- Give item
    AddItemToInventory(steamid, itemId, 1)
    return true, "Purchase successful"
end
```
## Get Sales Stats
```lua
function GetSalesStats(days)
    local since = os.time() - (days * 24 * 60 * 60)
    return transactionsDB:Aggregate({
        {
            ["$match"] = {
                created_at = { ["$gte"] = since }
            }
        },
        {
            ["$group"] = {
                _id = "$item_id",
                totalSales = { ["$sum"] = 1 },
                revenue = { ["$sum"] = "$price" }
            }
        },
        {
            ["$sort"] = { totalSales = -1 }
        }
    })
end
```
