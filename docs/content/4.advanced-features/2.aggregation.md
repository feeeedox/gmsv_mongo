---
title: Aggregation Pipelines
description: Process and analyze data with MongoDB aggregation
navigation:
  icon: i-lucide-bar-chart
---
## What is Aggregation?
Aggregation processes documents through a pipeline of stages:
```
Documents → Stage 1 → Stage 2 → Stage 3 → Results
```
## Basic Usage
```lua
local results = collection:Aggregate(pipeline)
```
## Common Stages
### $match - Filter
```lua
{
    ["$match"] = {
        active = true,
        level = { ["$gte"] = 10 }
    }
}
```
### $group - Group & Calculate
```lua
{
    ["$group"] = {
        _id = "$rank",
        count = { ["$sum"] = 1 },
        avgLevel = { ["$avg"] = "$level" },
        totalCredits = { ["$sum"] = "$credits" }
    }
}
```
### $sort - Sort Results
```lua
{
    ["$sort"] = { score = -1 }  -- -1 = descending
}
```
### $limit - Limit Results
```lua
{
    ["$limit"] = 10
}
```
### $project - Select Fields
```lua
{
    ["$project"] = {
        _id = 0,
        username = 1,
        level = 1
    }
}
```
## Real Examples
### Leaderboard
```lua
local leaderboard = players:Aggregate({
    { ["$match"] = { active = true } },
    { ["$sort"] = { score = -1 } },
    { ["$limit"] = 10 },
    {
        ["$project"] = {
            _id = 0,
            username = 1,
            score = 1,
            level = 1
        }
    }
})
```
### Statistics
```lua
local stats = players:Aggregate({
    {
        ["$group"] = {
            _id = nil,
            totalPlayers = { ["$sum"] = 1 },
            avgLevel = { ["$avg"] = "$level" },
            maxLevel = { ["$max"] = "$level" }
        }
    }
})
```
### Group by Category
```lua
local byRank = players:Aggregate({
    {
        ["$group"] = {
            _id = "$rank",
            count = { ["$sum"] = 1 },
            avgLevel = { ["$avg"] = "$level" }
        }
    },
    {
        ["$sort"] = { count = -1 }
    }
})
```
## Accumulator Operators
| Operator | Description |
|----------|-------------|
| `$sum` | Sum values |
| `$avg` | Average |
| `$min` | Minimum |
| `$max` | Maximum |
| `$first` | First value |
| `$last` | Last value |
| `$push` | Create array |
## Best Practices
::u-callout
---
icon: i-lucide-lightbulb
---
- Put `$match` early to filter data
- Use `$limit` to reduce processing
- Use `$project` to return only needed fields
- Aggregation is more efficient than Lua processing
::
