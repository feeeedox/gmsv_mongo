---
title: API Reference
description: Complete API documentation for gmsv_mongo
navigation:
  icon: i-lucide-book-open
---

## MongoDB Global

Global functions available after `require("mongo")`.

### MongoDB.Client

Create a MongoDB client connection.

```lua
local client = MongoDB.Client(connectionString)
```

**Parameters:**
- `connectionString` (string): MongoDB connection URI

**Returns:**
- `Client` object or `nil` on failure

**Example:**
```lua
local client = MongoDB.Client("mongodb://localhost:27017")
```

---

### MongoDB.ClientWithOptions

Create a MongoDB client with custom options.

```lua
local client = MongoDB.ClientWithOptions(connectionString, options)
```

**Parameters:**
- `connectionString` (string): MongoDB connection URI
- `options` (table): Connection options

**Options:**
| Option | Type | Description | Default |
|--------|------|-------------|---------|
| `app_name` | string | Application name in logs | - |
| `max_pool_size` | number | Maximum connections | 100 |
| `min_pool_size` | number | Minimum connections | 0 |
| `retry_writes` | boolean | Retry failed writes | true |
| `retry_reads` | boolean | Retry failed reads | true |
| `server_selection_timeout` | number | Server selection timeout (seconds) | 30 |
| `connect_timeout` | number | Connection timeout (seconds) | 10 |

**Returns:**
- `Client` object or `nil` on failure

**Example:**
```lua
local client = MongoDB.ClientWithOptions("mongodb://localhost:27017", {
    app_name = "MyGModServer",
    max_pool_size = 50,
    retry_writes = true
})
```

---

### MongoDB.Version

Get the module version.

```lua
local version = MongoDB.Version()
```

**Returns:**
- `string`: Version number (e.g., "2.0.0")

**Example:**
```lua
print("gmsv_mongo version:", MongoDB.Version())
```

---

### MongoDB.SuppressMessages

Toggle message suppression.

```lua
MongoDB.SuppressMessages(suppress)
```

**Parameters:**
- `suppress` (boolean): True to suppress messages, false to show

**Example:**
```lua
MongoDB.SuppressMessages(true)  -- Suppress info messages
```

---

## Client Object

Methods available on Client objects.

### client:Database

Get a database reference.

```lua
local database = client:Database(name)
```

**Parameters:**
- `name` (string): Database name

**Returns:**
- `Database` object

**Example:**
```lua
local db = client:Database("gameserver")
```

---

### client:ListDatabases

List all databases on the server.

```lua
local databases = client:ListDatabases()
```

**Returns:**
- `table`: Array of database names

**Example:**
```lua
local dbs = client:ListDatabases()
for i, name in ipairs(dbs) do
    print(i .. ". " .. name)
end
```

---

## Database Object

Methods available on Database objects.

### database:Collection

Get a collection reference.

```lua
local collection = database:Collection(name)
```

**Parameters:**
- `name` (string): Collection name

**Returns:**
- `Collection` object

**Example:**
```lua
local players = db:Collection("players")
```

---

### database:ListCollections

List all collections in the database.

```lua
local collections = database:ListCollections()
```

**Returns:**
- `table`: Array of collection names

**Example:**
```lua
local cols = db:ListCollections()
for i, name in ipairs(cols) do
    print(i .. ". " .. name)
end
```

---

### database:CreateCollection

Create a new collection.

```lua
local success = database:CreateCollection(name)
```

**Parameters:**
- `name` (string): Collection name

**Returns:**
- `boolean`: True if successful

**Example:**
```lua
local created = db:CreateCollection("new_collection")
```

::u-callout
---
icon: i-lucide-info
---
Collections are created automatically when you first insert data. This method is rarely needed.
::

---

### database:DropCollection

Drop (delete) a collection and all its documents.

```lua
local success = database:DropCollection(name)
```

**Parameters:**
- `name` (string): Collection name

**Returns:**
- `boolean`: True if successful

**Example:**
```lua
local dropped = db:DropCollection("old_collection")
```

---

### database:Stats

Get collection statistics.

```lua
local stats = database:Stats(collectionName)
```

**Parameters:**
- `collectionName` (string): Collection name

**Returns:**
- `table`: Statistics object

**Example:**
```lua
local stats = db:Stats("players")
if stats then
    print("Documents:", stats.count)
    print("Size:", stats.size, "bytes")
end
```

---

### database:Drop

Drop (delete) the entire database.

```lua
local success = database:Drop()
```

**Returns:**
- `boolean`: True if successful

**Example:**
```lua
-- ⚠️ DANGER: Deletes all data
local dropped = testDB:Drop()
```

---

## Collection Object

Methods available on Collection objects.

## CRUD Operations

### collection:InsertOne

Insert a single document.

```lua
local id = collection:InsertOne(document)
```

**Parameters:**
- `document` (table): Document to insert

**Returns:**
- `string`: Inserted document's ID

**Example:**
```lua
local id = players:InsertOne({
    steamid = "STEAM_0:1:12345",
    username = "Player1",
    level = 1
})
```

---

### collection:InsertMany

Insert multiple documents.

```lua
local ids = collection:InsertMany(documents)
```

**Parameters:**
- `documents` (table): Array of documents

**Returns:**
- `table`: Array of inserted document IDs

**Example:**
```lua
local ids = players:InsertMany({
    { username = "Player1", level = 1 },
    { username = "Player2", level = 2 },
    { username = "Player3", level = 3 }
})
```

---

### collection:Find

Find multiple documents.

```lua
local documents = collection:Find(filter, limit)
```

**Parameters:**
- `filter` (table): Query filter
- `limit` (number, optional): Maximum documents to return

**Returns:**
- `table`: Array of matching documents

**Example:**
```lua
local results = players:Find({ level = { ["$gte"] = 10 } }, 20)
```

---

### collection:FindOne

Find a single document.

```lua
local document = collection:FindOne(filter)
```

**Parameters:**
- `filter` (table): Query filter

**Returns:**
- `table`: First matching document, or `nil`

**Example:**
```lua
local player = players:FindOne({ steamid = "STEAM_0:1:12345" })
```

---

### collection:UpdateOne

Update a single document.

```lua
local count = collection:UpdateOne(filter, update, upsert)
```

**Parameters:**
- `filter` (table): Query filter
- `update` (table): Update operations
- `upsert` (boolean, optional): Create if doesn't exist (default: false)

**Returns:**
- `number`: Number of documents modified (0 or 1)

**Example:**
```lua
local updated = players:UpdateOne(
    { steamid = "STEAM_0:1:12345" },
    { ["$set"] = { level = 10 } },
    false
)
```

---

### collection:UpdateMany

Update multiple documents.

```lua
local count = collection:UpdateMany(filter, update, upsert)
```

**Parameters:**
- `filter` (table): Query filter
- `update` (table): Update operations
- `upsert` (boolean, optional): Create if none match (default: false)

**Returns:**
- `number`: Number of documents modified

**Example:**
```lua
local updated = players:UpdateMany(
    { active = true },
    { ["$inc"] = { bonus_credits = 100 } }
)
```

---

### collection:DeleteOne

Delete a single document.

```lua
local count = collection:DeleteOne(filter)
```

**Parameters:**
- `filter` (table): Query filter

**Returns:**
- `number`: Number of documents deleted (0 or 1)

**Example:**
```lua
local deleted = players:DeleteOne({ steamid = "STEAM_0:1:12345" })
```

---

### collection:DeleteMany

Delete multiple documents.

```lua
local count = collection:DeleteMany(filter)
```

**Parameters:**
- `filter` (table): Query filter

**Returns:**
- `number`: Number of documents deleted

**Example:**
```lua
local deleted = logs:DeleteMany({
    created_at = { ["$lt"] = os.time() - (30 * 24 * 60 * 60) }
})
```

---

### collection:Count

Count matching documents.

```lua
local count = collection:Count(filter)
```

**Parameters:**
- `filter` (table): Query filter

**Returns:**
- `number`: Count of matching documents

**Example:**
```lua
local total = players:Count({})
local active = players:Count({ active = true })
```

---

## Advanced Operations

### collection:Aggregate

Run an aggregation pipeline.

```lua
local results = collection:Aggregate(pipeline)
```

**Parameters:**
- `pipeline` (table): Array of aggregation stages

**Returns:**
- `table`: Array of result documents

**Example:**
```lua
local stats = players:Aggregate({
    {
        ["$group"] = {
            _id = "$rank",
            count = { ["$sum"] = 1 },
            avgLevel = { ["$avg"] = "$level" }
        }
    },
    {
        ["$sort"] = { count = -1 }
    }
})
```

---

### collection:CreateIndex

Create an index on the collection.

```lua
local indexName = collection:CreateIndex(keys, unique, name)
```

**Parameters:**
- `keys` (table): Fields to index (1 = ascending, -1 = descending)
- `unique` (boolean): Whether to enforce uniqueness
- `name` (string, optional): Index name

**Returns:**
- `string`: Index name

**Example:**
```lua
-- Simple index
players:CreateIndex({ steamid = 1 }, true, "steamid_unique")

-- Compound index
players:CreateIndex({ level = -1, score = -1 }, false, "level_score")
```

---

### collection:ListIndexes

List all indexes on the collection.

```lua
local indexes = collection:ListIndexes()
```

**Returns:**
- `table`: Array of index information

**Example:**
```lua
local indexes = players:ListIndexes()
for i, index in ipairs(indexes) do
    print(index.name)
end
```

---

### collection:DropIndex

Drop an index.

```lua
local success = collection:DropIndex(name)
```

**Parameters:**
- `name` (string): Index name

**Returns:**
- `boolean`: True if successful

**Example:**
```lua
local dropped = players:DropIndex("old_index")
```

---

## Query Operators

### Comparison

| Operator | Description | Example |
|----------|-------------|---------|
| `$eq` | Equal | `{ field = value }` |
| `$ne` | Not equal | `{ field = { ["$ne"] = value } }` |
| `$gt` | Greater than | `{ field = { ["$gt"] = value } }` |
| `$gte` | Greater than or equal | `{ field = { ["$gte"] = value } }` |
| `$lt` | Less than | `{ field = { ["$lt"] = value } }` |
| `$lte` | Less than or equal | `{ field = { ["$lte"] = value } }` |
| `$in` | In array | `{ field = { ["$in"] = {1, 2, 3} } }` |
| `$nin` | Not in array | `{ field = { ["$nin"] = {1, 2} } }` |

### Logical

| Operator | Description | Example |
|----------|-------------|---------|
| `$and` | Logical AND (implicit) | `{ field1 = val1, field2 = val2 }` |
| `$or` | Logical OR | `{ ["$or"] = { {f1 = v1}, {f2 = v2} } }` |
| `$not` | Logical NOT | `{ field = { ["$not"] = { ["$gt"] = 5 } } }` |
| `$nor` | Logical NOR | `{ ["$nor"] = { {f1 = v1}, {f2 = v2} } }` |

### Element

| Operator | Description | Example |
|----------|-------------|---------|
| `$exists` | Field exists | `{ field = { ["$exists"] = true } }` |
| `$type` | Field type | `{ field = { ["$type"] = "string" } }` |

### String

| Operator | Description | Example |
|----------|-------------|---------|
| `$regex` | Regex match | `{ field = { ["$regex"] = "pattern" } }` |

## Update Operators

### Field

| Operator | Description | Example |
|----------|-------------|---------|
| `$set` | Set field value | `{ ["$set"] = { field = value } }` |
| `$unset` | Remove field | `{ ["$unset"] = { field = "" } }` |
| `$rename` | Rename field | `{ ["$rename"] = { old = "new" } }` |
| `$setOnInsert` | Set only on insert (with upsert) | `{ ["$setOnInsert"] = { field = value } }` |
| `$currentDate` | Set to current date | `{ ["$currentDate"] = { field = true } }` |

### Numeric

| Operator | Description | Example |
|----------|-------------|---------|
| `$inc` | Increment | `{ ["$inc"] = { field = amount } }` |
| `$mul` | Multiply | `{ ["$mul"] = { field = multiplier } }` |
| `$min` | Set to minimum | `{ ["$min"] = { field = value } }` |
| `$max` | Set to maximum | `{ ["$max"] = { field = value } }` |

### Array

| Operator | Description | Example |
|----------|-------------|---------|
| `$push` | Add to array | `{ ["$push"] = { arr = value } }` |
| `$pull` | Remove from array | `{ ["$pull"] = { arr = value } }` |
| `$pop` | Remove first/last | `{ ["$pop"] = { arr = -1 } }` (-1=first, 1=last) |
| `$addToSet` | Add if unique | `{ ["$addToSet"] = { arr = value } }` |

## Aggregation Operators

### Pipeline Stages

| Stage | Description |
|-------|-------------|
| `$match` | Filter documents |
| `$group` | Group by field(s) |
| `$sort` | Sort documents |
| `$project` | Select/exclude fields |
| `$limit` | Limit results |
| `$skip` | Skip documents |
| `$count` | Count documents |
| `$lookup` | Join collections |

### Accumulator Operators (in $group)

| Operator | Description |
|----------|-------------|
| `$sum` | Sum values |
| `$avg` | Average values |
| `$min` | Minimum value |
| `$max` | Maximum value |
| `$first` | First value |
| `$last` | Last value |
| `$push` | Create array |

---
